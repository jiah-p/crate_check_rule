```toml
[advisory]
id = "CVE-2025-47735"
package = "wgp"
date = "2025-05-09"
url = "https://github.com/mheese/rust-pkcs11/issues/57"
categories = ["thread-safety"]

[versions]
patched = ["> 0.2.0"]
affected = ["<= 0.2.0"]
```

# Safety issues in `wgp`

## Description

inner::drop in `inner.rs` in the wgp crate through `10.2.0` for Rust lacks drop_slow thread synchronization.

## Details

a potential unsound issue in the drop of Inner, where it doesn't provide enough check to ensure the soundness.

```rs
fn drop(&mut self) { 
     #[inline(never)] 
     unsafe fn drop_slow(this: *mut Inner, old_refcount: usize) { 
         match old_refcount { 
             2 => (*this).waker.wake(), 
             1 => drop(Box::from_raw(this)), 
             _ => {} 
         } 
     } 
  
     let old_refcount = self.deref().refcount.fetch_sub(1, Ordering::Release); 
     if old_refcount > 2 { 
         return; 
     } 
     self.deref().refcount.load(Ordering::Acquire); 
     unsafe { drop_slow(self.0.as_ptr(), old_refcount) } 
 } 
```
There is no synchronization that ensures only one thread proceeds to the `drop(Box::from_raw(...))`. The fetch_sub with `Ordering::Release` and the later `load(Ordering::Acquire)` do not form a full acquireâ€“release synchronization that would ensure mutual exclusion or visibility of destruction.

## References

- [https://github.com/Nugine/wgp/issues/1 ](https://github.com/Nugine/wgp/issues/1 )
- [https://crates.io/crates/wgp ](https://crates.io/crates/wgp )