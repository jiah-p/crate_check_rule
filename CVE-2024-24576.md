```toml
[advisory]
id = "CVE-2024-24576"
package = "std"
aliases = ["GHSA-q455-m56c-85mh"]
date = "2024-04-10"
url = "https://www.cve.org/CVERecord?id=CVE-2024-24576"
categories = ["code-execution", "os-command-injection"]
keywords = ["cmd", "Command Injection"]
#cvss = "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H"

[versions]
patched = [">= 1.77.2"]
affected = ["< 1.77.2"]
```

# command injection vulnerabilities arising from `Command::arg` and `Command::args`

The Rust Security Response WG was notified that the Rust standard library did not properly escape arguments when invoking batch files (with the bat and cmd extensions) on Windows using `the Command API`. An attacker able to control the arguments passed to the spawned process could execute arbitrary shell commands by bypassing the escaping.

The severity of this vulnerability is critical if you are invoking batch files on Windows with untrusted arguments. No other platform or use is affected.

This vulnerability is identified by `CVE-2024-24576`.

## Overview

The `Command::arg` and `Command::args` APIs state in their documentation that the arguments will be passed to the spawned process as-is, regardless of the content of the arguments, and will not be evaluated by a `shell`. This means it should be safe to pass untrusted input as an argument.

On Windows, the implementation of this is more complex than other platforms, because the Windows API only provides a single string containing all the arguments to the spawned process, and it's up to the spawned process to split them. Most programs use the `standard C run-time argv`, which in practice results in a mostly consistent way arguments are splitted.

One exception though is `cmd.exe` (used among other things to execute batch files), which has its own argument splitting logic. That forces the standard library to implement custom escaping for arguments passed to batch files. Unfortunately it was reported that our escaping logic was not thorough enough, and it was possible to pass malicious arguments that would result in arbitrary shell execution.

## Affected Versions

All Rust versions before `1.77.2` on Windows are affected, if your code or one of your dependencies executes batch files with untrusted arguments. Other platforms or other uses on Windows are not affected.

## Mitigations

Due to the complexity of `cmd.exe`, we didn't identify a solution that would correctly escape arguments in all cases. To maintain our API guarantees, we improved the robustness of the escaping code, and changed the `Command API` to return an `InvalidInput error` when it cannot safely escape an argument. This error will be emitted when spawning the process.

The fix will be included in `Rust 1.77.2`, to be released later today.

If you implement the escaping yourself or only handle trusted inputs, on Windows you can also use the `CommandExt::raw_arg` method to bypass the standard library's escaping logic.

## Acknowledgements

We want to thank RyotaK for responsibly disclosing this to us according to the Rust security policy, and Simon Sawicki (Grub4K) for identifying some of the escaping rules we adopted in our fix.

We also want to thank the members of the Rust project who helped us disclose the vulnerability: Chris Denton for developing the fix; Mara Bos for reviewing the fix; Pietro Albini for writing this advisory; Pietro Albini, Manish Goregaokar and Josh Stone for coordinating this disclosure; Amanieu d'Antras for advising during the disclosure.
